@{
    ViewData["Title"] = "–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫";
}
@model IEnumerable<SlayLib.Models.ShoppingListItem>
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

<div class="container py-4" style="max-width: 900px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
            üõí @ViewData["Title"]
        </h1>
        @if (Model != null && Model.Any())
        {
            <form asp-action="Clear" method="post" onsubmit="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –æ—á–∏—Å—Ç–∏—Ç–∏ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫?');" style="display: inline;">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-outline-danger rounded-pill px-4 py-2">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ —Å–ø–∏—Å–æ–∫
                </button>
            </form>
        }
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="card shadow-sm rounded-4" style="border: none;">
            <div class="card-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border-radius: 1rem 1rem 0 0;">
                <h5 class="mb-0">üìã –ï–ª–µ–º–µ–Ω—Ç–∏ —Å–ø–∏—Å–∫—É (@Model.Count())</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush" id="shoppingList">
                    @foreach (var item in Model)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center @(item.IsBought ? "text-muted" : "")" 
                            data-item-id="@item.Id" 
                            style="background: transparent; border-bottom: 1px solid rgba(40, 167, 69, 0.1); @(item.IsBought ? "text-decoration: line-through;" : "")">
                            <div class="form-check d-flex align-items-center" style="flex: 1;">
                                <input class="form-check-input me-3" type="checkbox" 
                                       @(item.IsBought ? "checked" : "") 
                                       onchange="toggleBought(@item.Id, this.checked)"
                                       style="width: 1.25rem; height: 1.25rem; cursor: pointer;" />
                                <label class="form-check-label" style="cursor: pointer; flex: 1;" onclick="this.previousElementSibling.click();">
                                    <strong>@item.Name</strong>
                                    @if (!string.IsNullOrEmpty(item.Quantity))
                                    {
                                        <span class="text-muted ms-2">
                                            (@item.Quantity
                                            @if (!string.IsNullOrEmpty(item.Unit))
                                            {
                                                <text> @item.Unit</text>
                                            })
                                        </span>
                                    }
                                </label>
                            </div>
                            <button class="btn btn-sm btn-outline-danger rounded-pill" onclick="removeItem(@item.Id)" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                                üóëÔ∏è
                            </button>
                        </li>
                    }
                </ul>
            </div>
            <div class="card-footer bg-transparent" style="border-top: 1px solid rgba(40, 167, 69, 0.1);">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">
                        –ó–∞–≥–∞–ª–æ–º: <strong>@Model.Count()</strong> –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
                        (@Model.Count(i => !i.IsBought) –Ω–µ –∫—É–ø–ª–µ–Ω–æ)
                    </span>
                    <a asp-controller="Recipe" asp-action="Index" class="btn btn-outline-primary rounded-pill px-4 py-2">
                        ‚ûï –î–æ–¥–∞—Ç–∏ –∑ —Ä–µ—Ü–µ–ø—Ç—ñ–≤
                    </a>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center rounded-4">
            <h4>–í–∞—à —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</h4>
            <p>–î–æ–¥–∞–π—Ç–µ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ –∑ —Ä–µ—Ü–µ–ø—Ç—ñ–≤ –¥–æ —Å–ø–∏—Å–∫—É –ø–æ–∫—É–ø–æ–∫, —â–æ–± –ø–æ—á–∞—Ç–∏.</p>
            <a asp-controller="Recipe" asp-action="Index" class="btn btn-primary rounded-pill px-4 py-2 mt-3">
                –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ä–µ—Ü–µ–ø—Ç–∏
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        function toggleBought(itemId, isChecked) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("ToggleBought", "ShoppingList")';
            
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            if (token) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token;
                form.appendChild(tokenInput);
            }
            
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = itemId;
            form.appendChild(idInput);
            
            document.body.appendChild(form);
            
            fetch(form.action, {
                method: 'POST',
                body: new FormData(form)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const listItem = document.querySelector(`[data-item-id="${itemId}"]`);
                    if (data.isBought) {
                        listItem.classList.add('text-muted');
                        listItem.style.textDecoration = 'line-through';
                    } else {
                        listItem.classList.remove('text-muted');
                        listItem.style.textDecoration = '';
                    }
                }
            })
            .catch(error => {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                alert('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å—Ç–∞—Ç—É—Å—É.');
            })
            .finally(() => {
                document.body.removeChild(form);
            });
        }

        function removeItem(itemId) {
            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –µ–ª–µ–º–µ–Ω—Ç –∑—ñ —Å–ø–∏—Å–∫—É?')) {
                return;
            }

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("Remove", "ShoppingList")';
            
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            if (token) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token;
                form.appendChild(tokenInput);
            }
            
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = itemId;
            form.appendChild(idInput);
            
            document.body.appendChild(form);
            
            fetch(form.action, {
                method: 'POST',
                body: new FormData(form)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const listItem = document.querySelector(`[data-item-id="${itemId}"]`);
                    listItem.style.transition = 'opacity 0.3s';
                    listItem.style.opacity = '0';
                    setTimeout(() => {
                        listItem.remove();
                        // –û–Ω–æ–≤–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
                        const remainingItems = document.querySelectorAll('#shoppingList li').length;
                        if (remainingItems === 0) {
                            location.reload();
                        }
                    }, 300);
                }
            })
            .catch(error => {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                alert('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∞.');
            })
            .finally(() => {
                document.body.removeChild(form);
            });
        }
    </script>
}

